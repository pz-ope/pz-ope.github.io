---
layout: post
title: "增量数据采集 - Oracle CDC"
subtitle: 'Incremental Data Collection - Oracle CDC'
author: "pzw"
header-style: text
lang: en
tags:
  - Java后端
  - 数据库

---

# Oracle CDC 简介

CDC(Change Data Capture)。很多人都认为，只要是涉及到**数据库数据复制**和**增量数据抽取**，都是需要购买收费软件的。实际上，我们通过Oracle提供的`CDC`和`LogMiner`等免费工具也能实现数据库数据复制和增量数据抽取，各种数据复制软件只是使得获取增量数据更加便捷，或者是可以支持更多的扩展功能（例如：异构数据库之间的同步，ETL——单独的数据处理引擎，将业务系统的数据经过抽取、清洗转换之后加载到数据仓库的过程），但实际Oracle本身是支持CDC机制，只是很少有人关注，操作起来也有些复杂，而且据传言并不稳定，常常见到论坛上爆出一些莫名其妙的问题。

## 数据抽取

数据抽取是从数据源中抽取数据的[过程](https://baike.baidu.com/item/过程/8386928)。

数据抽取是指从**源数据源系统**抽取目的数据源系统需要的[数据](http://wiki.mbalib.com/wiki/数据)。实际应用中，数据源较多采用的是[关系数据库](http://wiki.mbalib.com/wiki/关系数据库)。

数据的抽取就是从异构数据源抽取数据,但是并不是所有数据源中的数据都有实际的价值。业务人员和设计人员需要分析讨论哪些数据有价值，哪些数据可以忽略，然后制定抽取策略。==数据的抽取分为数据的全量抽取和数据的增量抽取==。其中，全量抽取类似于数据迁移或数据复制，它将原数据表中的数据全部抽取出来;经过上次抽取后，源数据表中的数据出现变化时，会进行增量抽取。增量抽取是抽取数据源表中新增或被修改的数据。

数据抽取的方式：

* 全量抽取

  全量抽取类似于[数据迁移](http://wiki.mbalib.com/wiki/数据迁移)或数据复制，它将数据源中的表或视图的数据原封不动的从数 据库中抽取出来，并转换成自己的ETL 工具可以识别的格式。全量抽取比较简单。

* 增量抽取

  增量抽取只抽取自上次抽取以来[数据库](http://wiki.mbalib.com/wiki/数据库)中要抽取的表中新增或修改的数据。在ETL 使用过程中，增量抽取较全量抽取应用更广。如何捕获变化的数据是增量抽取的关键。对捕获方法一般有两点要求：准确性，能够将业务系统中的变化数据按一定的[频率](http://wiki.mbalib.com/wiki/频率)准确地捕获到；性能，不能对业务系统造成太大的压力，影响现有业务。

#  增量数据采集概述

数据采集通常是指ETL过程中Extract-数据抽取部分。除了ETL外在不同应用系统之间通常也需要传递数据，在某些环境条件限制下不能将数据从一个系统直接移到另一个系统，`只能借助文本来作为中间媒介传递数据`，且文本的生成有时间窗口的限制，所以对数据采集即数据抽取的性能有一定的要求。对增加数据的采集的方法常用的有以下几种:

1. 时间戳（Timestamps on rows)
2. 版本号(Version Numbers on rows）
3. 状态指示(Status indicators on rows)
4. 时间戳、版本号、状态指示混合使用(Time/Version/Status on rows)
5. 触发器 (Triggers on tables)
6. 表差异(Table differencing)
7. 数据库的日志扫描(Log scanners on databases)

## 触发器方式（又称快照式）

在要抽取的表上建立需要的触发器，一般要建立插入、修改、删除三个触发器，每当源表中的数据发生变化，就被相应的触发器将变化的数据写入一个临时表，抽取线程从临时表中抽取数据，临时表中抽取过的数据被标记或删除。

* 优点：数据抽取的性能高，ETL 加载规则简单，速度快，不需要修改业务系统表结构，可以实现数据的递增加载。
*  缺点：要求业务表建立触发器，对业务系统有一定的影响，容易对[源数据库](http://wiki.mbalib.com/wiki/源数据库)构成威胁。

## 时间戳方式

它是一种基于快照比较的变化数据捕获方式，在源表上增加一个时间戳字段，系统中更新修改表数据的时候，同时修改时间戳字段的值。当进行数据抽取时，通过比较上次抽取时间与时间戳字段的值来决定抽取哪些数据。有的数据库的时间戳支持自动更新，即表的其它字段的数据发生改变时，自动更新时间戳字段的值。有的数据库不支持时间戳的自动更新，这就要求业务系统在更新业务数据时，手工更新时间戳字段。

* 优点：同触发器方式一样，时间戳方式的性能也比较好，ETL 系统设计清晰，源数据抽取相对清楚简单，可以实现数据的递增加载。
* 缺点：时间戳维护需要由业务系统完成，对业务系统也有很大的倾入性（加入额外的时间戳字段），特别是对不支持时间戳的自动更新的数据库，还要求业务系统进行额外的更新时间戳操作；另外，无法捕获对时间戳以前数据的delete和update 操作，在数据准确性上受到了一定的限制。

## 全表删除插入方式

每次ETL 操作均删除目标表数据，由ETL 全新加载数据。

* 优点：ETL 加载规则简单，速度快。
* 缺点：对于维表加外键不适应，当业务系统产生删除数据操作时，综合数据库将不会记录到所删除的历史数据，不可以实现数据的递增加载；同时对于目标表所建立的[关联关系](http://wiki.mbalib.com/wiki/关联关系)，需要重新进行创建。

## 全表比对方式

全表比对的方式是ETL 工具事先为要抽取的表建立一个结构类似的临时表，该临时表记录源表主键以及根据所有字段的数据计算出来，每次进行数据抽取时，对源表和临时表进行的比对，如有不同，进行Update 操作，如目标表没有存在该主键值，表示该记录还没有，即进行Insert 操作。

* 优点：对已有系统表结构不产生影响，不需要修改业务操作程序，所有抽取规则由ETL完成，管理维护统一，可以实现数据的递增加载，没有风险。
* 缺点：ETL 比对较复杂，设计较为复杂，速度较慢。与触发器和时间戳方式中的主动通知不同，全表比对方式是被动的进行全表数据的比对，性能较差。当表中没有主键或唯一列且含有重复记录时，全表比对方式的准确性较差。

## 日志表方式

在业务系统中添加系统日志表，当业务数据发生变化时，更新维护日志表内容，当作ETL 加载时，通过读日志表数据决定加载那些数据及如何加载。

* 优点：不需要修改业务系统表结构，源数据抽取清楚，速度较快。可以实现数据的递增加载。 
*  缺点：日志表维护需要由业务系统完成，需要对业务系统业务操作程序作修改，记录日志信息。日志表维护较为麻烦，对原有系统有较大影响。工作量较大，改动较大，有一定风险。

## Oracle 变化数据捕捉（CDC 方式）

通过分析数据库自身的日志来判断变化的数据。Oracle 的改变数据捕获（CDC，Changed Data Capture）技术是这方面的代表。CDC 特性是在Oracle9i 数据库中引入的。CDC 能够帮助你识别从上次抽取之后发生变化的数据。利用CDC，在对源表进行insert、update 或 delete 等操作的同时就可以提取数据，并且变化的数据被保存在数据库的变化表中。这样就可以捕获发生变化的数据，然后利用数据库视图以一种可控的方式提供给目标系统。

> CDC 分为同步模式和异步模式，同步模式实时的捕获变化数据并存储到变化表中，发布者与订阅都位于同一数据库中；异步模式则是基于Oracle 的流复制技术。

* 优点：提供了易于使用的API 来设置CDC 环境，缩短ETL 的时间。不需要修改业务系统表结构，可以实现数据的递增加载。
* 缺点：业务系统数据库版本与[产品](http://wiki.mbalib.com/wiki/产品)不统一，难以统一实现，实现过程相对复杂，并且需深入研究方能实现。或者通过第三方工具实现，[价格](http://wiki.mbalib.com/wiki/价格)昂贵。

# CDC的发布订阅模型

CDC 体系结构基于发布/订阅模型。发布者捕捉变化数据并提供给订阅者。订阅者使用从发布者那里获得的变化数据。通常，CDC 系统拥有一个发布者和多个订阅者。发布者首先需要识别捕获变化数据所需的源表。然后，它捕捉变化的数据并将其保存在特别创建的变化表中。它还使订阅者能够控制对变化数据的访问。订阅者需要清楚自己感兴趣的是哪些变化数据。一个订阅者可能不会对发布者发布的所有数据都感兴趣。订阅者需要创建一个订阅者视图来访问经发布者授权可以访问的变化数据。

CDC有几个重要的基本概念需要先明确一下：

* 源表(Source Table)，业务数据库的需要捕获数据的源表
* 变化表(Change Table) ，保存从源表捕获的变化数据(包括各种DML产生的数据)
* 变化集(Change Set)，是保证事务一致性的数据集合。一个变化集对应多个变化表
* 订阅视图(Subscription View),提供给读取变化表数据的视图
* 订阅窗口(Subscription Window) ,定义了查看变化数据的时间范围.就象一个观察变化数据的滑动窗口。变化数据处理完成后，可以对清除订阅窗口。

# Oracle CDC机制

##  同步机制（Synchronous Change Data Capture Configuration）

原理很简单，原表、目标表必须是同一个库，采用触发器的机制（设置同步CDC后，并看不到触发器，但实际运行机理还是触发器的机制）将原表内容复制到另一个目标表。这个机制就不多说了，和自己给表建触发器没什么太大差别。

<img src="/img/image/image-20220525221219499.png" alt="image-20220525221219499" style="zoom:80%;" />

##  异步在线日志CDC（Asynchronous HotLog Configuration）

这个过程已经没有触发器了，而是使用Redo Log，但是使用在线日志，并不是归档日志。并且原表、目标表仍然必须是同一个库。这种模式是相对简单的，同时这种模式是在Oracle 10以上才产生的，9i是没有这个机制的。

<img src="/img/image/image-20220525221533130.png" alt="image-20220525221533130" style="zoom:80%;" />

## 异步分布式CDC （Asynchronous Distributed HotLog Configuration）

实际这个模式是对异步在线日志CDC的一种优化，也比较容易理解，就是加入了DB-LINK机制，使原表、目标表不在同一个数据库。实际是和异步在线日志CDC没有什么本质区别。

<img src="/img/image/image-20220525221709797.png" alt="image-20220525221709797" style="zoom:80%;" />

## 异步在线日志复制CDC（Asynchronous Autolog Online Change Data Capture Configuration）

异步在线日志复制CDC模式就要高级很多了，使用Standby Redo Log（热备数据库日志），实际就是使用Oracle的热备机制，将日志写入了热备数据库，目标表就可以建立在热备库上，这对主数据库性能影响就进一步降低。

<img src="/img/image/image-20220525221944182.png" alt="image-20220525221944182" style="zoom:80%;" />

## 归档日志CDC （Asynchronous AutoLog Archive Change Data Capture Configuration）

归档日志CDC模式是最完美的模式，但是需要有机制可以获取归档日志（并行文件系统技术），然后在目标端分析归档日志进行变化数据处理，这种模式理论上来讲，几乎可以完全不影响原数据库的性能。

<img src="/img/image/image-20220525222225429.png" alt="image-20220525222225429" style="zoom:80%;" />

## 总结

|     **模式**      |               **临时数据库的位置、硬件和软件**               |                         **捕获机制**                         |                     **源数据库性能影响**                     |
| :---------------: | :----------------------------------------------------------: | :----------------------------------------------------------: | :----------------------------------------------------------: |
|       同步        | 位置必须与源数据库相同, 因此硬件、操作系统和 Oracle 数据库版本与源系统相同。 |      更改数据将作为它所反映的同一事务的一部分自动提交。      |         将开销添加到源数据库事务以执行更改数据捕获。         |
|    异步 HotLog    | 位置必须与源数据库相同, 因此硬件、操作系统和 Oracle 数据库版本与源系统相同。 | 更改数据是从当前的联机重做日志文件中捕获的。更改集将在提交新事务时自动填充。 | 对源数据库事务的影响最小, 以执行补充日志记录。执行更改数据捕获所需的其他源数据库开销。 |
| 异步分布式 HotLog | 位置从源数据库中远程。硬件、操作系统和 Oracle 数据库版本可以与源系统不同。 | 更改数据是从当前的联机重做日志文件中捕获的。当新提交的事务到达临时数据库时, 将自动填充更改集。 | 对源数据库事务的影响最小, 以执行补充日志记录。在挖掘联机重做日志文件时, 源数据库上的一些开销会发生。 |
| 异步 AutoLog 在线 | 位置从源数据库中远程。硬件、操作系统和 Oracle 数据库版本与源系统相同。 | 从备用重做日志文件中捕获更改数据。当新提交的事务到达临时数据库时, 将自动填充更改集。 | 对源数据库事务的影响最小, 以执行补充日志记录。恢复传输服务的最小源数据库开销。 |
| 异步 AutoLog 存档 | 位置从源数据库中远程。硬件、操作系统和 Oracle 数据库版本与源系统相同。 | 更改数据是从已存档的重做日志文件中捕获的。更改集将自动填充, 因为已存档的重做日志文件到达临时数据库。 | 对源数据库事务的影响最小, 以执行补充日志记录。恢复传输服务的最小源数据库开销。 |

